name: Update Environment Variables

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'ì—…ë°ì´íŠ¸í•  ì„œë¹„ìŠ¤ ì„ íƒ'
        required: true
        type: choice
        options:
          - server
          - client
          - both

jobs:
  update-env-vars:
    runs-on: ubuntu-latest

    steps:
      # 1) ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      # 2) Google Cloud ì¸ì¦
      - name: ğŸ”‘ Authenticate with Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 3) gcloud CLI ì„¤ì¹˜ ë° í”„ë¡œì íŠ¸ ì„¤ì •
      - name: ğŸ”§ Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # 4) ì„œë²„ .env íŒŒì¼ ìƒì„± ë° ì—…ë°ì´íŠ¸
      - name: ğŸ”„ Update Server .env File
        if: ${{ inputs.service == 'server' || inputs.service == 'both' }}
        run: |
          cd server
          cat <<EOF > .env
          NODE_ENV=production
          API_KEY=${{ secrets.API_KEY }}
          ES_NODE=${{ secrets.ES_NODE }}
          MONGO_URI=${{ secrets.MONGO_URI }}
          GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}
          PORT=3001
          CORS_ORIGIN=${{ secrets.CORS_ORIGIN }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          REDIS_URL=${{ secrets.REDIS_URL }}
          ELASTICSEARCH_URL=${{ secrets.ELASTICSEARCH_URL }}
          ELASTICSEARCH_USERNAME=${{ secrets.ELASTICSEARCH_USERNAME }}
          ELASTICSEARCH_PASSWORD=${{ secrets.ELASTICSEARCH_PASSWORD }}
          EOF
          
          # ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .env
          git commit -m "Update server .env file"
          git push

      # 5) í´ë¼ì´ì–¸íŠ¸ .env íŒŒì¼ ìƒì„± ë° ì—…ë°ì´íŠ¸
      - name: ğŸ”„ Update Client .env File
        if: ${{ inputs.service == 'client' || inputs.service == 'both' }}
        run: |
          cd client
          cat <<EOF > .env
          REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }}
          REACT_APP_NAVER_MAP_CLIENT_ID=${{ secrets.REACT_APP_NAVER_MAP_CLIENT_ID }}
          REACT_APP_NAVER_MAP_CLIENT_SECRET=${{ secrets.REACT_APP_NAVER_MAP_CLIENT_SECRET }}
          REACT_APP_GA_MEASUREMENT_ID=${{ secrets.REACT_APP_GA_MEASUREMENT_ID }}
          EOF
          
          # ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .env
          git commit -m "Update client .env file"
          git push 